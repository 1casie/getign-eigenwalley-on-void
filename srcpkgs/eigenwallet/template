pkgname=eigenwallet
version=3.2.1
revision=1
build_style=generic
hostmakedepends="pkg-config cargo just nodejs yarn git tar wget" 
makedepends="openssl-devel sqlite-devel libgit2-1.8-devel libwebkit2gtk41-devel gtk+3-devel
 libayatana-appindicator-devel libsoup3-devel atk-devel cairo-devel
 gdk-pixbuf-devel pango-devel cmake patch"
depends="libwebkit2gtk41"
short_desc="Monero wallet for atomic swaps with GUI"
maintainer="Casie Nakamura <casie@tuta.io>"
license="GPL-3.0-or-later"
homepage="https://github.com/eigenwallet/core"
distfiles="https://github.com/eigenwallet/core/archive/refs/tags/${version}.tar.gz"
checksum="de036373724706674f33ee8b3984e7ab3f45857b43203295c301d45de6c64aca"

do_build() {
    just gui_install

    cd monero-sys

    echo "=== Downloading Monero source directly ==="
    wget -O monero-source.tar.gz https://github.com/monero-project/monero/archive/refs/tags/v0.18.4.3.tar.gz
    tar -xf monero-source.tar.gz

    rm -rf monero
    mv monero-0.18.4.3 monero

    if [ -f patches/eigenwallet_0001_wallet2_api_allow_subtract_from_fee.patch ]; then
        cd monero
        patch -p1 < ../patches/eigenwallet_0001_wallet2_api_allow_subtract_from_fee.patch
        cd ..
    fi

    cd ..

    just swap
}

do_install() {
    if [ -f target/release/eigenwallet ]; then
        vbin target/release/eigenwallet
    fi

    if [ -f assets/eigenwallet.desktop ]; then
        vinstall assets/eigenwallet.desktop 644 usr/share/applications
    fi
    if [ -f assets/icon.png ]; then
        vinstall assets/icon.png 644 usr/share/pixmaps eigenwallet.png
    fi
}
